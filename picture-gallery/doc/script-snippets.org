* Curl tests
  #+BEGIN_SRC shell :results output file :file test_curl_output :output-dir /tmp/
    cookiejar="/tmp/test_curl_cookiejar"
    rand_userid="foo${RANDOM}"

    cleanup_tmp_files() {
        rm "${cookiejar}" "/tmp/test_curl_output"
    }

    cleanup_record_from_db() {
        local user_id=${1:?"Fatal. Must pass unique user id."}

        psql -d "gallery" -c "DELETE from users where id = $(printf "\'%s\'" ${user_id});"
    }

    post_urlencoded_form() {
        local route=${1:?"Fail. Please pass route."}
        local data=${2:?"Fail. Please pass urlencoded data."}
        local hostport=${3:-"localhost:8080"}

        curl -L -c "${cookiejar}" \
             -POST -H "Content-Type: application/x-www-form-urlencoded" \
             -d "${data}" "http://${hostport}/${route}"
    }

    post_image_form() {
        local route=${1:?"Fail. Please pass route."}
        local imgfile=${2:?"Fail. Please pass urlencoded data."}
        local hostport=${3:-"localhost:8080"}

        curl -L -c "${cookiejar}" \
             -POST -H "Content-Type: multipart/form-data" \
             -F file=@${imgfile} "http://${hostport}/${route}"
    }

    goto_url() {
        local route=${1:?"Fail. Please pass route."}
        local hostport=${2:-"localhost:8080"}

        curl -L -b "${cookiejar}" \
             -GET "http://${hostport}/${route}"
    }

    about_to_execute() {
        printf "\n\n===%s===\n" "${1}"
    }

    execute_auth_actions() {
        printf "===%s===" "About to execute various auth actions for user ${rand_userid}"

        about_to_execute "POST REGISTER"
        post_urlencoded_form "register" "id=${rand_userid}&pass=randompass&pass1=randompass"

        about_to_execute "POST LOGIN"
        post_urlencoded_form "login" "id=${rand_userid}&pass=randompass"

        about_to_execute "POST LOGIN AGAIN"
        post_urlencoded_form "login" "id=${rand_userid}&pass=randompass"

        about_to_execute "POST REGISTER AGAIN"
        post_urlencoded_form "register" "id=${rand_userid}&pass=randompass&pass1=randompass"

        about_to_execute "GET LOGIN redirects to HOME (diff below must be empty)"
        diff -s --label "<REDIRECT FROM LOGIN>" <(goto_url "login") --label "<LOGGED IN HOME PAGE>" <(goto_url ' ')

        about_to_execute "GET REGISTER redirects to HOME (diff below must be empty)"
        diff -s --label "<REDIRECT FROM REGISTER>" <(goto_url "register") --label "<LOGGED IN HOME PAGE>" <(goto_url ' ')

        about_to_execute "DELETE ${rand_userid} record from test db"
        cleanup_record_from_db ${rand_userid}
    }

    execute_upload_image() {
        # hex codes from wikipedia for PNG
        redpixel="$(cat <<EOF
    89 50 4E 47 0D 0A 1A 0A 00 00 00 0D 49 48 44 52
    00 00 00 01 00 00 00 01 08 02 00 00 00 90 77 53
    DE 00 00 00 0C 49 44 41 54 08 D7 63 F8 CF C0 00
    00 03 01 01 00 18 DD 8D B0 00 00 00 00 49 45 4E
    44 AE 42 60 82
    EOF
                )"
        imgfile="/tmp/redpixel.png"

        xxd -r -p <(echo "${redpixel}") > ${imgfile}

        about_to_execute "POST image file"
        post_image_form "upload" "${imgfile}" |
            # the page must have this error message
            grep -o "success"

        rm ${imgfile}
    }

    execute_upload_null_image() {
        imgfile="/tmp/emptyfile"

        cat /dev/null > "${imgfile}"

        about_to_execute "POST NULL file"
        post_image_form "upload" "${imgfile}" |
            # although image is null, it's still a file
            grep -o "success"
        rm ${imgfile}
    }

    execute_upload_no_image() {
        about_to_execute "POST NO file at all"
        post_urlencoded_form "upload" "file=" |
            # the page must have this error message
            grep -o "please select a file to upload"
    }


    execute_auth_actions
    execute_upload_image
    execute_upload_null_image
    execute_upload_no_image
    # cleanup_tmp_files # call if needed
  #+END_SRC

  #+RESULTS:
  [[file:/tmp/test_curl_output]]
